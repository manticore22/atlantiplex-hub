# Atlantiplex Security Vulnerability Remediation & Hardening Guide

## Executive Summary

This guide addresses known security vulnerabilities and implements industry-standard hardening practices across the Atlantiplex stack (Node.js, Python, Docker, Kubernetes).

---

## 1. Dependency Vulnerability Scanning & Remediation

### Node.js Dependencies (npm)

#### Scan Command
```bash
npm audit --audit-level=moderate
npx snyk test
npm outdated
```

#### High-Risk Dependencies to Review
- **express** ‚Äî Web framework (keep up-to-date)
- **jsonwebtoken** ‚Äî JWT handling (critical for auth)
- **bcrypt** ‚Äî Password hashing (check version >= 5.x)
- **axios/node-fetch** ‚Äî HTTP clients (SSRF risks)
- **stripe** ‚Äî Payment processing (PCI compliance)
- **database drivers** ‚Äî SQL injection risks

#### Remediation Steps

**1. Update package.json with secure versions:**
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "jsonwebtoken": "^9.1.2",
    "bcryptjs": "^2.4.3",
    "helmet": "^7.1.0",
    "express-rate-limit": "^7.1.5",
    "express-validator": "^7.0.0",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "axios": "^1.6.5",
    "pg": "^8.11.3",
    "redis": "^4.6.12",
    "sequelize": "^6.35.2"
  },
  "devDependencies": {
    "npm-audit-resolver": "^3.0.0"
  }
}
```

**2. Install security audit tools:**
```bash
# npm audit built-in
npm audit

# Snyk (free tier)
npm install -g snyk
snyk auth
snyk test

# OWASP Dependency Check
npm install -D --save-dev snyk snyk-to-sarif
```

**3. Create .npmrc for secure defaults:**
```ini
# ~/.npmrc or project .npmrc
legacy-peer-deps=false
audit-level=moderate
fund=false
```

### Python Dependencies (pip)

#### Scan Command
```bash
pip install safety
safety check
pip-audit
```

#### High-Risk Python Packages
- **Flask** ‚Äî Web framework (versions < 2.3 have vulnerabilities)
- **SQLAlchemy** ‚Äî ORM (SQL injection if misused)
- **requests** ‚Äî HTTP client (SSRF risks)
- **PyJWT** ‚Äî JWT handling
- **cryptography** ‚Äî Encryption library

#### Remediation Steps

**1. Update requirements.txt with secure versions:**
```
Flask==2.3.3
Flask-SQLAlchemy==3.0.5
Werkzeug==2.3.7
SQLAlchemy==2.0.21
PyJWT==2.8.1
requests==2.31.0
cryptography==41.0.4
python-dotenv==1.0.0
gunicorn==21.2.0
psycopg2-binary==2.9.9
redis==5.0.1
```

**2. Create requirements-dev.txt with dev tools:**
```
pytest==7.4.3
pytest-cov==4.1.0
black==23.11.0
flake8==6.1.0
bandit==1.7.5
safety==2.3.5
pip-audit==2.6.1
```

**3. Create security scanning script:**
```bash
#!/bin/bash
# scripts/security-scan.sh
set -e

echo "üîí Running security scans..."

# Python
echo "Scanning Python dependencies..."
pip install safety
safety check

# Alternative: pip-audit
pip-audit

# Bandit for code analysis
pip install bandit
bandit -r . --exclude ./venv,./tests

echo "‚úÖ Security scan complete"
```

---

## 2. Docker Security Hardening

### Multi-Stage Build Security

**Before (Vulnerable):**
```dockerfile
FROM node:20
COPY . .
RUN npm install
CMD ["npm", "start"]
```

**After (Hardened):**
```dockerfile
# Build stage - includes everything
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force
COPY . .
RUN npm run build

# Runtime stage - minimal and secure
FROM node:20-alpine
WORKDIR /app

# Install security tools
RUN apk add --no-cache dumb-init ca-certificates

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Copy only necessary files from builder
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./

# Security labels
LABEL security="hardened" \
      image-version="1.0" \
      scan-date="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

# Environment
ENV NODE_ENV=production \
    NODE_OPTIONS="--no-deprecation --max-old-space-size=512" \
    NPM_CONFIG_AUDIT=false

EXPOSE 3000

USER nodejs

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})" || exit 1

# Proper signal handling
ENTRYPOINT ["/usr/sbin/dumb-init", "--"]
CMD ["node", "dist/server.js"]
```

### .dockerignore Security

```
# Hide sensitive files
.env
.env.*
.git
.gitignore
.npmrc
.yarnrc
.ssh
*.pem
*.key
secrets/
credentials/
.aws
.docker

# Remove build artifacts
node_modules
npm-debug.log
yarn-error.log
.npm
.yarn-cache

# Remove docs and tests
docs/
examples/
tests/
test/
*.test.js
*.spec.js
coverage/
.nyc_output

# Build files
dist/
build/
.next
out/

# IDE files
.vscode
.idea
.DS_Store
*.swp
*.swo
```

### Docker Scan Integration

```bash
#!/bin/bash
# scripts/docker-scan.sh

IMAGE="${1:-atlantiplex-app:latest}"

echo "üîí Scanning Docker image: $IMAGE"

# Build image first
docker build -t "$IMAGE" .

# Scan with Docker Scout (recommended)
docker scout cves "$IMAGE" --details

# Alternative: Trivy scan
trivy image --severity HIGH,CRITICAL "$IMAGE"

# Alternative: Grype scan
grype "$IMAGE" -o table --fail-on critical

echo "‚úÖ Docker scan complete"
```

---

## 3. Application Security Hardening

### Node.js/Express Security

**Create security middleware (middleware/security.js):**
```javascript
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const { body, validationResult } = require('express-validator');

// Security headers via Helmet
const helmetConfig = helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"], // Reduce unsafe-inline for production
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.stripe.com"],
      fontSrc: ["'self'"],
      objectSrc: ["'none'"],
      mediaSrc: ["'self'"],
      frameSrc: ["'self'"],
    },
  },
  crossOriginEmbedderPolicy: true,
  crossOriginOpenerPolicy: true,
  crossOriginResourcePolicy: { policy: "cross-origin" },
  dnsPrefetchControl: true,
  frameguard: { action: 'deny' },
  hidePoweredBy: true,
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true,
  },
  ieNoOpen: true,
  noSniff: true,
  originAgentCluster: true,
  referrerPolicy: { policy: "strict-origin-when-cross-origin" },
  xssFilter: true,
});

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // Limit each IP to 100 requests per windowMs
  message: 'Too many requests from this IP, please try again later.',
  standardHeaders: true, // Return rate limit info in `RateLimit-*` headers
  legacyHeaders: false, // Disable the `X-RateLimit-*` headers
  store: new RedisStore({
    client: redisClient,
    prefix: 'rl:', // rate limit prefix
  }),
});

// Strict rate limit for login
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  skipSuccessfulRequests: true,
  message: 'Too many login attempts, please try again later.',
});

// API rate limit (stricter)
const apiLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 60,
  message: 'Too many API requests, please slow down.',
});

// Input validation middleware
const validateInput = [
  body('*.').trim().escape(),
  (req, res, next) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    next();
  },
];

// CORS configuration (restrictive)
const corsConfig = {
  origin: process.env.CORS_ORIGIN?.split(',') || ['https://atlantiplex.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  maxAge: 86400, // 24 hours
  optionsSuccessStatus: 200,
};

// Secure session configuration
const sessionConfig = {
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only in production
    httpOnly: true, // Prevent XSS access
    sameSite: 'strict', // CSRF protection
    maxAge: 24 * 60 * 60 * 1000, // 24 hours
  },
};

module.exports = {
  helmetConfig,
  limiter,
  loginLimiter,
  apiLimiter,
  validateInput,
  corsConfig,
  sessionConfig,
};
```

**Apply middleware in Express app (app.js):**
```javascript
const express = require('express');
const cors = require('cors');
const compression = require('compression');
const {
  helmetConfig,
  limiter,
  loginLimiter,
  apiLimiter,
  corsConfig,
  sessionConfig,
} = require('./middleware/security');

const app = express();

// Security middleware (apply first)
app.use(helmetConfig);
app.use(cors(corsConfig));
app.use(compression()); // Reduce response size

// Rate limiting
app.use('/api/', apiLimiter);
app.use('/auth/login', loginLimiter);

// Body parser with size limits
app.use(express.json({ limit: '10kb' }));
app.use(express.urlencoded({ limit: '10kb', extended: true }));

// Trust proxy (for accurate IP in rate limiting behind reverse proxy)
app.set('trust proxy', 1);

// Add security headers
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
  next();
});

// Remove sensitive headers
app.disable('x-powered-by');
app.disable('etag');

// Routes
app.use('/api/auth', require('./routes/auth'));
app.use('/api/users', require('./routes/users'));

// Error handling (don't expose stack traces in production)
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(err.status || 500).json({
    error: process.env.NODE_ENV === 'production' 
      ? 'Internal Server Error' 
      : err.message,
  });
});

module.exports = app;
```

### Python/Flask Security

**Create security config (config/security.py):**
```python
import os
from datetime import timedelta

class SecurityConfig:
    """Security configuration for Flask app"""
    
    # CORS
    CORS_ORIGINS = os.getenv('CORS_ORIGIN', 'https://atlantiplex.example.com').split(',')
    CORS_ALLOW_HEADERS = ['Content-Type', 'Authorization']
    CORS_METHODS = ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS']
    CORS_EXPOSE_HEADERS = ['Content-Range', 'X-Content-Range']
    CORS_SUPPORTS_CREDENTIALS = True
    CORS_MAX_AGE = 86400  # 24 hours
    
    # Session
    SESSION_COOKIE_SECURE = True  # HTTPS only
    SESSION_COOKIE_HTTPONLY = True  # No JS access
    SESSION_COOKIE_SAMESITE = 'Strict'  # CSRF protection
    SESSION_COOKIE_NAME = '__Host-session'  # Secure naming
    PERMANENT_SESSION_LIFETIME = timedelta(hours=24)
    
    # CSRF
    WTF_CSRF_CHECK_DEFAULT = True
    WTF_CSRF_TIME_LIMIT = None  # No time limit on CSRF token
    
    # Security headers
    SECURITY_HEADERS = {
        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
        'X-Content-Type-Options': 'nosniff',
        'X-Frame-Options': 'DENY',
        'X-XSS-Protection': '1; mode=block',
        'Referrer-Policy': 'strict-origin-when-cross-origin',
        'Permissions-Policy': 'geolocation=(), microphone=(), camera=()',
        'Content-Security-Policy': (
            "default-src 'self'; "
            "script-src 'self'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self'; "
            "connect-src 'self' https://api.stripe.com; "
            "frame-ancestors 'none'"
        ),
    }
    
    # Input validation
    MAX_CONTENT_LENGTH = 10 * 1024 * 1024  # 10MB max request size
    JSON_SORT_KEYS = False
    
    # Database
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_size': 10,
        'pool_recycle': 3600,
        'pool_pre_ping': True,  # Verify connections
        'echo': False,
    }
```

**Apply security in Flask app (app.py):**
```python
from flask import Flask, jsonify, request, make_response
from flask_cors import CORS
from flask_talisman import Talisman
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from flask_sqlalchemy import SQLAlchemy
from config.security import SecurityConfig
import logging
import os

app = Flask(__name__)
app.config.from_object(SecurityConfig)

# Security middleware
db = SQLAlchemy(app)

# CORS
CORS(app, resources={
    r"/api/*": {
        "origins": SecurityConfig.CORS_ORIGINS,
        "allow_headers": SecurityConfig.CORS_ALLOW_HEADERS,
        "methods": SecurityConfig.CORS_METHODS,
        "supports_credentials": SecurityConfig.CORS_SUPPORTS_CREDENTIALS,
    }
})

# Talisman for security headers
Talisman(app, 
    force_https=True,
    strict_transport_security=True,
    strict_transport_security_max_age=31536000,
    content_security_policy=True,
    x_content_type_options=True,
    x_frame_options='DENY',
)

# Rate limiting
limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"],
    storage_uri="redis://:{}@localhost:6379/0".format(os.getenv('REDIS_PASSWORD')),
)

# Logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Remove sensitive headers
@app.after_request
def remove_headers(response):
    response.headers.pop('Server', None)
    response.headers.pop('X-Powered-By', None)
    # Add security headers
    for header, value in SecurityConfig.SECURITY_HEADERS.items():
        response.headers[header] = value
    return response

# Input validation decorator
def validate_json(*expected_args):
    def decorator(f):
        def decorated_function(*args, **kwargs):
            json_data = request.get_json()
            if not json_data:
                return jsonify({'error': 'No JSON data'}), 400
            for expected_arg in expected_args:
                if expected_arg not in json_data:
                    return jsonify({'error': f'Missing {expected_arg}'}), 400
            return f(*args, **kwargs)
        decorated_function.__name__ = f.__name__
        return decorated_function
    return decorator

# Error handling
@app.errorhandler(400)
def bad_request(error):
    logger.warning(f"Bad request: {request.path}")
    return jsonify({'error': 'Bad request'}), 400

@app.errorhandler(401)
def unauthorized(error):
    logger.warning(f"Unauthorized access: {request.path}")
    return jsonify({'error': 'Unauthorized'}), 401

@app.errorhandler(403)
def forbidden(error):
    logger.warning(f"Forbidden access: {request.path}")
    return jsonify({'error': 'Forbidden'}), 403

@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'Not found'}), 404

@app.errorhandler(500)
def internal_error(error):
    logger.error(f"Internal error: {str(error)}")
    db.session.rollback()
    return jsonify({'error': 'Internal server error'}), 500

# Health check endpoint
@app.route('/api/health', methods=['GET'])
@limiter.exempt
def health():
    return jsonify({'status': 'ok'}), 200

if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0', port=5000)
```

---

## 4. Environment Variable Security

### Secure .env Handling

**Bad (.env file committed to repo):**
```bash
# ‚ùå DO NOT DO THIS
DB_PASSWORD=super_secret_123
JWT_SECRET=my_secret_key
STRIPE_KEY=sk_live_abc123
```

**Good (.env.example without secrets):**
```bash
# .env.example (safe to commit)
NODE_ENV=production
DB_HOST=postgres
DB_PORT=5432
DB_USER=atlantiplex
DB_PASSWORD=CHANGE_ME
DB_NAME=atlantiplex
JWT_SECRET=CHANGE_ME
JWT_REFRESH_SECRET=CHANGE_ME
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=CHANGE_ME
CORS_ORIGIN=https://atlantiplex.example.com
API_URL=https://api.atlantiplex.example.com
STRIPE_SECRET_KEY=sk_live_CHANGE_ME
STRIPE_WEBHOOK_SECRET=whsec_CHANGE_ME
LOG_LEVEL=info
SESSION_SECRET=CHANGE_ME
```

**Add to .gitignore:**
```bash
# Environment variables
.env
.env.local
.env.*.local
.env.production
.env.development
.env.test

# Sensitive files
*.pem
*.key
*.jks
secrets/
credentials/
.aws/
.docker/config.json
.npmrc
.yarnrc.yml
```

**Python dotenv setup (config/__init__.py):**
```python
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Validate required variables
REQUIRED_VARS = [
    'DB_PASSWORD',
    'JWT_SECRET',
    'REDIS_PASSWORD',
    'STRIPE_SECRET_KEY',
]

for var in REQUIRED_VARS:
    if not os.getenv(var):
        raise ValueError(f"Missing required environment variable: {var}")

# Additional validation
if len(os.getenv('DB_PASSWORD', '')) < 16:
    raise ValueError("DB_PASSWORD must be at least 16 characters")
if len(os.getenv('JWT_SECRET', '')) < 32:
    raise ValueError("JWT_SECRET must be at least 32 characters")
```

---

## 5. Database Security

### PostgreSQL Hardening

**Secure connection string:**
```
postgresql://atlantiplex:${DB_PASSWORD}@postgres:5432/atlantiplex?sslmode=require&connect_timeout=10
```

**SQL Injection Prevention (Node.js):**
```javascript
// Bad - SQL Injection vulnerability
const query = `SELECT * FROM users WHERE email = '${email}'`;

// Good - Parameterized query
const query = 'SELECT * FROM users WHERE email = $1';
db.query(query, [email]);

// With ORM (Sequelize)
User.findOne({
  where: { email: sequelize.literal(email) }  // Still escape!
});
```

**SQL Injection Prevention (Python):**
```python
# Bad - SQL Injection vulnerability
query = f"SELECT * FROM users WHERE email = '{email}'"
db.session.execute(query)

# Good - SQLAlchemy ORM (parameterized)
user = User.query.filter_by(email=email).first()

# Good - Raw SQL with parameters
from sqlalchemy import text
result = db.session.execute(text("SELECT * FROM users WHERE email = :email"), {"email": email})
```

---

## 6. Authentication & Authorization Security

### JWT Best Practices

**Secure JWT setup (Node.js):**
```javascript
const jwt = require('jsonwebtoken');
const crypto = require('crypto');

// Generate secure tokens
function generateAccessToken(userId) {
  return jwt.sign(
    { userId, type: 'access' },
    process.env.JWT_SECRET,
    {
      algorithm: 'HS256',
      expiresIn: '15m', // Short expiration
      issuer: 'atlantiplex-api',
      audience: 'atlantiplex-client',
    }
  );
}

function generateRefreshToken(userId) {
  return jwt.sign(
    { userId, type: 'refresh', tokenId: crypto.randomBytes(16).toString('hex') },
    process.env.JWT_REFRESH_SECRET,
    {
      algorithm: 'HS256',
      expiresIn: '7d', // Longer expiration
      issuer: 'atlantiplex-api',
    }
  );
}

// Verify JWT with options
function verifyToken(token, secret, type) {
  try {
    return jwt.verify(token, secret, {
      algorithms: ['HS256'],
      issuer: 'atlantiplex-api',
      audience: type === 'access' ? 'atlantiplex-client' : undefined,
    });
  } catch (error) {
    throw new Error('Invalid token');
  }
}

// Revoke tokens (store in Redis)
async function revokeToken(tokenId) {
  await redis.setex(`revoked:${tokenId}`, 7 * 24 * 60 * 60, '1');
}

async function isTokenRevoked(tokenId) {
  return await redis.exists(`revoked:${tokenId}`);
}
```

**Password hashing (Node.js):**
```javascript
const bcrypt = require('bcryptjs');

// Hash password (minimum 12 rounds)
async function hashPassword(password) {
  const salt = await bcrypt.genSalt(12);
  return bcrypt.hash(password, salt);
}

// Verify password
async function verifyPassword(password, hash) {
  return bcrypt.compare(password, hash);
}

// Password validation
function validatePassword(password) {
  if (password.length < 12) return false;
  if (!/[A-Z]/.test(password)) return false; // Uppercase
  if (!/[a-z]/.test(password)) return false; // Lowercase
  if (!/[0-9]/.test(password)) return false; // Number
  if (!/[!@#$%^&*]/.test(password)) return false; // Special char
  return true;
}
```

---

## 7. API Security

### API Key Management

```javascript
// API key validation middleware
const validateApiKey = (req, res, next) => {
  const apiKey = req.headers['x-api-key'];
  
  if (!apiKey) {
    return res.status(401).json({ error: 'Missing API key' });
  }
  
  // Hash the API key and compare (don't store plain keys)
  const hashedKey = crypto.createHash('sha256').update(apiKey).digest('hex');
  const storedKey = process.env.API_KEY_HASH;
  
  if (!crypto.timingSafeEqual(Buffer.from(hashedKey), Buffer.from(storedKey))) {
    return res.status(401).json({ error: 'Invalid API key' });
  }
  
  next();
};

// Use in routes
app.post('/api/webhook', validateApiKey, handleWebhook);
```

---

## 8. Kubernetes Security Hardening

### Pod Security Standards

Already implemented in manifests, but verify:

```yaml
# In k8s manifests - example from 05-node-deployments.yaml
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  capabilities:
    drop:
    - ALL
    add:
    - NET_BIND_SERVICE
```

### Network Policies

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: atlantiplex
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend
  namespace: atlantiplex
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: atlantiplex
    ports:
    - protocol: TCP
      port: 80

---
# Allow stage-server to receive from nginx-ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-api-from-ingress
  namespace: atlantiplex
spec:
  podSelector:
    matchLabels:
      app: stage-server
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx-ingress
    ports:
    - protocol: TCP
      port: 9001
```

---

## 9. CI/CD Security

### GitHub Actions Security Scan

**.github/workflows/security.yml:**
```yaml
name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  npm-audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: '20'
    - run: npm ci
    - run: npm audit --audit-level=moderate

  snyk-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  docker-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    - uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  sast:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: securego/gosec@master
      with:
        args: '-no-fail -fmt json -out reports/gosec.json ./...'
```

---

## 10. Logging & Monitoring Security

### Secure Logging

**What to log:**
- Authentication attempts (successes and failures)
- Authorization failures
- Data access events
- Configuration changes
- Error conditions
- API rate limit violations

**What NOT to log:**
- Passwords
- API keys
- Credit card numbers
- JWT tokens
- Personal identifiable information (PII)

**Secure logging config (Node.js):**
```javascript
const winston = require('winston');

const logger = winston.createLogger({
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.splat(),
    winston.format.json(),
  ),
  transports: [
    new winston.transports.File({
      filename: '/app/logs/error.log',
      level: 'error',
    }),
    new winston.transports.File({
      filename: '/app/logs/combined.log',
    }),
  ],
});

// Mask sensitive data
function maskSensitiveData(data) {
  const masked = { ...data };
  if (masked.password) masked.password = '***REDACTED***';
  if (masked.token) masked.token = '***REDACTED***';
  if (masked.apiKey) masked.apiKey = '***REDACTED***';
  return masked;
}

logger.info('User login', maskSensitiveData({ userId, email }));
```

---

## 11. Third-Party Security

### Stripe PCI Compliance

```javascript
// Never handle raw card data
// Always use Stripe.js and Elements

// Only store Stripe tokens
const token = await stripe.createToken(cardElement);
await savePaymentMethod(token.id); // Save token ID only, not card data

// Use Stripe API key from environment
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// Validate webhook signatures
const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET;
const sig = req.headers['stripe-signature'];

try {
  const event = stripe.webhooks.constructEvent(
    req.body,
    sig,
    endpointSecret
  );
} catch (err) {
  return res.status(400).send(`Webhook Error: ${err.message}`);
}
```

---

## 12. Security Scanning Tools

### Install and Run

```bash
#!/bin/bash
# scripts/full-security-audit.sh

set -e

echo "üîí Running full security audit..."

# 1. npm audit
echo "Scanning npm dependencies..."
npm audit --audit-level=moderate || true

# 2. Snyk
echo "Running Snyk scan..."
snyk test || true

# 3. OWASP Dependency Check
echo "Running OWASP Dependency Check..."
docker run --rm -v "$(pwd):/src" owasp/dependency-check --scan /src || true

# 4. Trivy (for containers)
echo "Scanning Docker images..."
trivy image atlantiplex-stage:latest || true
trivy image atlantiplex-flask:latest || true

# 5. Bandit (Python security)
echo "Running Bandit (Python)..."
pip install bandit
bandit -r . --exclude ./venv,./node_modules -f csv -o reports/bandit-report.csv || true

# 6. SonarQube (code quality)
echo "Running SonarQube scan..."
sonar-scanner \
  -Dsonar.projectKey=atlantiplex \
  -Dsonar.sources=. \
  -Dsonar.host.url=http://sonarqube:9000 \
  -Dsonar.login=$SONARQUBE_TOKEN || true

echo "‚úÖ Security audit complete"
echo "üìä Results available in ./reports/"
```

---

## 13. Remediation Checklist

- [ ] Run `npm audit` and fix all moderate/high/critical vulnerabilities
- [ ] Update all production dependencies to latest secure versions
- [ ] Apply Helmet.js security middleware to Express app
- [ ] Implement rate limiting on all API endpoints
- [ ] Add input validation and sanitization
- [ ] Implement Content Security Policy (CSP)
- [ ] Add CORS configuration (restrictive)
- [ ] Implement secure session cookies (httpOnly, secure, sameSite)
- [ ] Set up environment variables properly (.env, no secrets in code)
- [ ] Implement parameterized database queries
- [ ] Add JWT token expiration and refresh logic
- [ ] Implement proper password hashing (bcrypt, 12+ rounds)
- [ ] Apply security contexts in Kubernetes manifests
- [ ] Implement network policies in Kubernetes
- [ ] Set up vulnerability scanning in CI/CD
- [ ] Configure secure logging (no PII/secrets)
- [ ] Implement API key validation
- [ ] Enable HTTPS only (HTTP ‚Üí HTTPS redirect)
- [ ] Set up error handling (no stack traces in production)
- [ ] Implement audit logging
- [ ] Regular backup and disaster recovery testing
- [ ] Security training for development team
- [ ] Implement bug bounty program
- [ ] Set up security monitoring and alerts

---

## 14. Security Headers

All responses should include:

```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
```

---

## 15. Compliance & Standards

- ‚úÖ **OWASP Top 10** ‚Äî Address injection, broken auth, sensitive data exposure, etc.
- ‚úÖ **CWE-25** ‚Äî Most dangerous software weaknesses
- ‚úÖ **NIST Cybersecurity Framework** ‚Äî Best practices
- ‚úÖ **PCI DSS** ‚Äî If handling card data (use Stripe)
- ‚úÖ **GDPR** ‚Äî If serving EU users (privacy controls, data retention)
- ‚úÖ **SOC 2** ‚Äî If required by customers (audit, access controls, monitoring)

---

## References

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- OWASP Cheat Sheet Series: https://cheatsheetseries.owasp.org/
- Node.js Security Best Practices: https://nodejs.org/en/docs/guides/security/
- Express.js Security: https://expressjs.com/en/advanced/best-practice-security.html
- Docker Security: https://docs.docker.com/engine/security/
- Kubernetes Security: https://kubernetes.io/docs/concepts/security/
- Npm Audit: https://docs.npmjs.com/cli/v6/commands/npm-audit
- Snyk: https://snyk.io/
- OWASP Dependency Check: https://owasp.org/www-project-dependency-check/

---

**Status:** ‚úÖ Complete vulnerability remediation guide
**Last Updated:** 2024
**Severity:** Critical & High Priority

Implement these fixes immediately for production deployment.
